<!-- =============================================
  APP DE REPORTES TÉCNICOS (VERSIÓN SIMPLE, SIN SERVICE WORKER)
  - Un solo archivo: index.html
  - Exportación a PDF con jsPDF
  - Consecutivo (Número de reporte) persistente en localStorage
  - Guardado de reportes en localStorage (lista)
============================================== -->

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reportes Técnicos – Versión Simple</title>
  <meta name="description" content="Reporte técnico de equipos médicos con PDF y consecutivo; sin Service Worker." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b1020; --card:#121a34; --muted:#8aa0c6; --text:#ebf0ff; --border:#253055; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0a0f1e,#0b1228 40%,#09102a);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:rgba(9,16,42,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    h1{margin:0;font-size:1.4rem;font-weight:800}
    .row{display:grid;grid-template-columns:1fr;gap:18px}
    @media (min-width:1100px){.row{grid-template-columns:560px 1fr;align-items:start}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card h2{margin:0 0 10px;font-size:1.1rem}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:.92rem}
    input[type="text"],input[type="number"],input[type="date"],input[type="time"],input[type="email"],textarea,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0f1732;color:var(--text);outline:none}
    textarea{min-height:90px;resize:vertical}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
    .muted{color:var(--muted);font-size:.9rem}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    button,.btn{appearance:none;border:1px solid var(--border);background:#101a35;color:var(--text);border-radius:14px;padding:10px 14px;font-weight:600;cursor:pointer;box-shadow:var(--shadow)}
    button.primary{background:#2d7bd9;border-color:#2d7bd9}
    button.success{background:#18a877;border-color:#159569}
    button.danger{background:#e74a3b;border-color:#c0392b}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(84px,1fr));gap:8px;margin-top:8px}
    .thumbs img{width:100%;height:74px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
    canvas#sigPad{width:100%;height:170px;background:#0f1732;border:1px dashed #2c3b6a;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);font-weight:600}
    .right{text-align:right}
    .nowrap{white-space:nowrap}
    .footer{color:var(--muted);font-size:.85rem;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Reportes Técnicos – Versión Simple (sin offline)</h1>
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <!-- Formulario -->
      <section class="card">
        <h2>Nuevo reporte</h2>
        <form id="reporteForm">
          <div class="grid-4">
            <div>
              <label>N° de reporte (consecutivo)</label>
              <input type="text" id="numReporte" readonly />
            </div>
            <div>
              <label>Fecha</label>
              <input type="date" id="fecha" required />
            </div>
            <div>
              <label>Hora inicio</label>
              <input type="time" id="horaIni" required />
            </div>
            <div>
              <label>Hora fin</label>
              <input type="time" id="horaFin" required />
            </div>
          </div>

          <div class="grid-3">
            <div>
              <label>Cliente / Clínica / Hospital</label>
              <input type="text" id="cliente" placeholder="Ej. Clínica Santa María" required />
            </div>
            <div>
              <label>Responsable en sitio</label>
              <input type="text" id="responsable" placeholder="Nombre y apellido" required />
            </div>
            <div>
              <label>Correo del cliente (para enviar PDF)</label>
              <input type="email" id="correo" placeholder="cliente@ejemplo.com" />
            </div>
          </div>

          <h3 class="muted">Equipo atendido</h3>
          <div class="grid-3">
            <div>
              <label>Marca</label>
              <input type="text" id="marca" required />
            </div>
            <div>
              <label>Modelo</label>
              <input type="text" id="modelo" required />
            </div>
            <div>
              <label>N° de serie</label>
              <input type="text" id="serie" required />
            </div>
          </div>

          <div class="grid-2">
            <div>
              <label>Actuación</label>
<select id="actuacion">
  <option>Mtto Preventivo</option>
  <option>Mtto Correctivo</option>
  <option>Instalación de Repuesto</option>
  <option>Otro</option>
</select>
            </div>
            <div>
              <label>Cantidad</label>
              <input type="number" id="cantidad" step="0.1" min="0" value="1" />
            </div>
          </div>

          <label>Descripción de falla / solicitud</label>
          <textarea id="falla" required></textarea>

          <label>Acciones realizadas / diagnóstico</label>
          <textarea id="acciones" required></textarea>

          <div class="grid-3">
            <div>
              <label>Repuestos utilizados</label>
              <input type="text" id="repuestos" placeholder="Separar por coma" />
            </div>
            <div>
              <label>Horas trabajadas</label>
              <input type="number" id="horas" step="0.1" min="0" value="1" />
            </div>
            <div>
              <label>Estado final</label>
              <select id="estado">
                <option>Operativo</option>
                <option>Operativo con observaciones</option>
                <option>En espera de repuesto</option>
                <option>No operativo</option>
              </select>
            </div>
          </div>

          <label>Fotografías (evidencia) — usa la cámara del móvil</label>
          <input type="file" id="fotos" accept="image/*" capture="environment" multiple />
          <div id="thumbs" class="thumbs"></div>

          <div class="grid-2">
            <div>
              <label>Logo empresa (opcional)</label>
              <input type="file" id="logo" accept="image/*" />
              <div class="btns"><button type="button" id="fijarLogo" class="btn">Guardar logo como fijo</button></div>
            </div>
            <div>
              <label>Firma del cliente</label>
              <canvas id="sigPad"></canvas>
              <div class="btns"><button type="button" id="limpiarFirma" class="btn">Limpiar firma</button></div>
            </div>
          </div>

          <div class="btns">
            <button type="button" class="primary" id="guardar">Guardar local</button>
            <button type="button" class="success" id="pdf">Generar PDF</button>
            <button type="reset" class="danger">Limpiar formulario</button>
          </div>
          <div class="footer">Datos y consecutivo en <strong>localStorage</strong>. Sin Service Worker.</div>
        </form>
      </section>

      <!-- Lista -->
      <section class="card">
        <h2>Reportes guardados</h2>
        <table>
          <thead>
            <tr><th>Reporte</th><th>Fecha</th><th>Cliente</th><th>Equipo</th><th class="right">Acciones</th></tr>
          </thead>
          <tbody id="tabla"></tbody>
        </table>
        <div class="btns">
          <button id="exportarTodo" class="btn">Exportar JSON</button>
          <button id="importarBtn" class="btn">Importar JSON</button>
          <input type="file" id="importarInput" accept="application/json" style="display:none" />
        </div>
      </section>
    </div>

    <p class="footer">Formato de PDF alineado al ejemplo de Bennu (cabecera con datos de empresa, bloque DATOS CLIENTE, tabla de ACTUACIONES y Observaciones, fotos y firma). </p>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.10/dist/signature_pad.umd.min.js"></script>
  <script>
    /**************** Empresa - cabecera fija (edita estos valores si quieres) ****************/
    const HEADER = {
      company: 'Bennu Healthcare Solutions',
      legalId: '3-101804878',
      address: 'Sabana Sur, Mata Redonda, Centro Comercial del Sur',
      email: 'serviciotecnico@bennucr.com',
      phone: 'Teléfono: 6037-4749',
    };

    /**************** Persistencia: reportes + consecutivo + logo fijo ****************/
    const LS_KEY_REPORTES = 'reportes_simple_list';
    const LS_KEY_CONSEC   = 'reportes_simple_consecutivo';
    const LS_KEY_LOGO     = 'reportes_simple_logo_fijo';

    function loadReportes(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_REPORTES)||'[]'); }catch(e){ return []; } }
    function saveReportes(arr){ localStorage.setItem(LS_KEY_REPORTES, JSON.stringify(arr)); }

    function getNextConsecutivo(){ let n = parseInt(localStorage.getItem(LS_KEY_CONSEC)||'56',10); const next = n + 1; localStorage.setItem(LS_KEY_CONSEC, String(next)); return next; }
    function peekConsecutivo(){ let n = parseInt(localStorage.getItem(LS_KEY_CONSEC)||'56',10); return n + 1; }

    function getLogoFijo(){ return localStorage.getItem(LS_KEY_LOGO); }
    function setLogoFijo(dataURL){ localStorage.setItem(LS_KEY_LOGO, dataURL); }

    /**************** Firma ****************/
    const canvas = document.getElementById('sigPad');
    const signaturePad = new window.SignaturePad(canvas, { backgroundColor: 'rgba(0,0,0,0)' });
    function resizeCanvas() { const ratio = Math.max(window.devicePixelRatio || 1, 1); canvas.width = canvas.offsetWidth * ratio; canvas.height = canvas.offsetHeight * ratio; const ctx = canvas.getContext('2d'); ctx.scale(ratio, ratio); signaturePad.clear(); }
    window.addEventListener('resize', resizeCanvas); window.addEventListener('orientationchange', resizeCanvas); resizeCanvas();
    document.getElementById('limpiarFirma').addEventListener('click', () => signaturePad.clear());

    /**************** Logo ****************/
    const logoInput = document.getElementById('logo');
    let logoDataURL = null;
    const logoGuardado = getLogoFijo(); if (logoGuardado) logoDataURL = logoGuardado;
    logoInput.addEventListener('change', async (ev) => { const f = ev.target.files?.[0]; logoDataURL = f ? await fileToDataURL(f) : null; });
    document.getElementById('fijarLogo').addEventListener('click', async () => { if (!logoDataURL) { alert('Carga un logo primero.'); return; } setLogoFijo(logoDataURL); toast('Logo fijo guardado'); });

    /**************** Fotos ****************/
    const fotosInput = document.getElementById('fotos');
    const thumbs = document.getElementById('thumbs');
    let fotosDataURLs = [];
    fotosInput.addEventListener('change', async (ev) => { thumbs.innerHTML = ''; fotosDataURLs = []; const files = Array.from(ev.target.files || []); for (const f of files) { const url = await fileToDataURL(f); fotosDataURLs.push(url); const img = document.createElement('img'); img.src = url; thumbs.appendChild(img); } });

    function fileToDataURL(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); }); }

    /**************** Utilidades ****************/
    function pad2(n){return (n<10?'0':'')+n}
    function initFechaHora(){ const d = new Date(); document.getElementById('fecha').value = d.toISOString().slice(0,10); document.getElementById('horaIni').value = pad2(d.getHours())+":"+pad2(d.getMinutes()); document.getElementById('horaFin').value = document.getElementById('horaIni').value; }
    function escapeHTML(str=''){ return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
    function calcDuracion(h1, h2){ const [h1h,h1m]=h1.split(':').map(Number); const [h2h,h2m]=h2.split(':').map(Number); let a=h1h*60+h1m, b=h2h*60+h2m; if (b<a) b+=24*60; const d=b-a; const hh=Math.floor(d/60), mm=d%60; return `${hh}:${pad2(mm)}`; }

    /**************** Form data ****************/
    function formDataToObj(asignarConsecutivo){
      const get = id => document.getElementById(id).value.trim();
      const firma = signaturePad.isEmpty() ? null : signaturePad.toDataURL('image/png');
      const id = `${Date.now()}-${Math.random().toString(36).slice(2,7)}`;
      const consecutivo = asignarConsecutivo ? getNextConsecutivo() : parseInt(document.getElementById('numReporte').value || peekConsecutivo(), 10);
      const dur = calcDuracion(get('horaIni'), get('horaFin'));
      return { id, consecutivo, fecha:get('fecha'), horaIni:get('horaIni'), horaFin:get('horaFin'), duracion:dur, cliente:get('cliente'), responsable:get('responsable'), correo:get('correo'), marca:get('marca'), modelo:get('modelo'), serie:get('serie'), actuacion:get('actuacion'), cantidad:get('cantidad'), falla:get('falla'), acciones:get('acciones'), repuestos:get('repuestos'), horas:get('horas'), estado:get('estado'), fotos:fotosDataURLs, logo:logoDataURL||getLogoFijo(), firma };
    }

    /**************** Guardar / Cargar / Borrar ****************/
    async function guardarLocal(){ const obj = formDataToObj(true); const arr = loadReportes(); arr.push(obj); saveReportes(arr); renderTabla(); document.getElementById('numReporte').value = peekConsecutivo(); toast(`Guardado reporte #${obj.consecutivo}`); }
    document.getElementById('guardar').addEventListener('click', guardarLocal);

    function loadToForm(r){ document.getElementById('numReporte').value = r.consecutivo; document.getElementById('fecha').value = r.fecha; document.getElementById('horaIni').value = r.horaIni; document.getElementById('horaFin').value = r.horaFin; document.getElementById('cliente').value = r.cliente; document.getElementById('responsable').value = r.responsable; document.getElementById('correo').value = r.correo || ''; document.getElementById('marca').value = r.marca; document.getElementById('modelo').value = r.modelo; document.getElementById('serie').value = r.serie; document.getElementById('actuacion').value = r.actuacion||''; document.getElementById('cantidad').value = r.cantidad||'1'; document.getElementById('falla').value = r.falla; document.getElementById('acciones').value = r.acciones; document.getElementById('repuestos').value = r.repuestos || ''; document.getElementById('horas').value = r.horas || ''; document.getElementById('estado').value = r.estado || 'Operativo'; fotosDataURLs = r.fotos || []; thumbs.innerHTML = ''; for (const url of fotosDataURLs){ const img = document.createElement('img'); img.src = url; thumbs.appendChild(img); } (r.logo)&&(logoDataURL=r.logo); signaturePad.clear(); if (r.firma){ const img = new Image(); img.onload = ()=>{ const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); }; img.src = r.firma; } }

    async function renderTabla(){ const tbody = document.getElementById('tabla'); const datos = loadReportes(); datos.sort((a,b)=> b.consecutivo - a.consecutivo); tbody.innerHTML = ''; for (const r of datos){ const tr = document.createElement('tr'); tr.innerHTML = `<td>#${r.consecutivo}</td><td class="nowrap">${r.fecha} ${r.horaIni}-${r.horaFin}</td><td>${escapeHTML(r.cliente)}</td><td>${escapeHTML(r.marca)} ${escapeHTML(r.modelo)} <span class="muted">#${escapeHTML(r.serie)}</span></td><td class="right"><button class=\"btn\" data-act=\"pdf\" data-id=\"${r.id}\">PDF</button> <button class=\"btn\" data-act=\"view\" data-id=\"${r.id}\">Cargar</button> <button class=\"btn\" data-act=\"del\" data-id=\"${r.id}\">Borrar</button></td>`; tbody.appendChild(tr); }
      tbody.querySelectorAll('button').forEach(btn => btn.addEventListener('click', async ev => { const id = ev.currentTarget.dataset.id; const act = ev.currentTarget.dataset.act; const all = loadReportes(); const r = all.find(x=>x.id===id); if (!r) return; if (act==='del') { const filtered = all.filter(x=>x.id!==id); saveReportes(filtered); renderTabla(); toast('Eliminado'); return; } if (act==='view') { loadToForm(r); toast(`Cargado reporte #${r.consecutivo}`); return; } if (act==='pdf') { generarPDF(r); return; } })); }

    /**************** PDF – layout alineado al ejemplo ****************/
  function generarPDF(sourceObj){
  const obj = sourceObj || formDataToObj(false);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });

  const M = 36; let y = M;

  // ===== Cabecera (logo grande) =====
  if (obj.logo) { try { doc.addImage(obj.logo, 'PNG', M, y, 150, 75); } catch(e) {} }
  const rightX = M + 170;
  doc.setFont('helvetica','bold'); doc.setFontSize(12);
  doc.text(HEADER.company, rightX, y + 14);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(HEADER.legalId,   rightX, y + 30);
  doc.text(HEADER.address,   rightX, y + 46);
  doc.text(HEADER.email,     rightX, y + 62);
  doc.text(HEADER.phone,     rightX, y + 78);
  doc.text(HEADER.technician,rightX, y + 94);

  y += 110;
  doc.setDrawColor(100,120,150); doc.setLineWidth(0.7);
  doc.line(M, y, 595 - M, y);

  // ===== OT =====
  y += 18;
  doc.setFont('helvetica','bold'); doc.setFontSize(12);
  doc.text(`Num. Orden de trabajo: ${String(obj.consecutivo).padStart(5,'0')}`, M, y);

  y += 18;
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(`Fecha: ${obj.fecha}`, M, y);
  doc.text(`Hora Inicio: ${obj.horaIni}`, M + 180, y);
  doc.text(`Hora Fin: ${obj.horaFin}`,   M + 340, y);
  doc.text(`Tiempo: ${obj.duracion}`,    595 - M, y, { align: 'right' });

  // ===== DATOS DEL CLIENTE (bloque ancho) =====
  y += 22;
  doc.setFont('helvetica','bold'); doc.setFontSize(11);
  doc.text('DATOS DEL CLIENTE', M, y);

  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  y += 16; doc.text(`Cliente: ${obj.cliente || '-'}`, M, y);
  y += 16; doc.text(`Responsable: ${obj.responsable || '-'}`, M, y);
  if (obj.correo) { y += 16; doc.text(`Correo: ${obj.correo}`, M, y); }

  // Separador
  y += 12; doc.setDrawColor(100,120,150); doc.line(M, y, 595 - M, y);

  // ===== ACTUACIONES / CANTIDAD =====
  y += 18;
  doc.setFont('helvetica','bold'); doc.setFontSize(11);
  doc.text('ACTUACIONES', M, y);
  doc.text('CANTIDAD', 595 - M, y, { align: 'right' });

  y += 14; doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(String(obj.actuacion || '-'), M, y);
  doc.text(String(obj.cantidad || '1'),  595 - M, y, { align: 'right' });

  // Separador
  y += 16; doc.setDrawColor(100,120,150); doc.line(M, y, 595 - M, y);

  // ===== OBSERVACIONES =====
  y += 18; doc.setFont('helvetica','bold'); doc.setFontSize(11);
  doc.text('Observaciones:', M, y);

  y += 14; doc.setFont('helvetica','normal'); doc.setFontSize(10);
  const obsLines = doc.splitTextToSize(obj.acciones || '-', 595 - 2*M);
  obsLines.forEach(line => { if (y > doc.internal.pageSize.getHeight() - 80) { doc.addPage(); y = M; } doc.text(line, M, y); y += 12; });

  // Separador
  if (y < doc.internal.pageSize.getHeight() - 80) { y += 6; doc.setDrawColor(100,120,150); doc.line(M, y, 595 - M, y); }

  // ===== FOTOS =====
  if (obj.fotos && obj.fotos.length){
    doc.setFont('helvetica','bold'); doc.setFontSize(11);
    for (let i = 0; i < obj.fotos.length; i++){
      const need = 16 + 320 + 10;
      if (y + need > doc.internal.pageSize.getHeight() - 60) { doc.addPage(); y = M; }
      y += 16; doc.text(`FOTO ${i+1}:`, M, y);
      y += 6;
      try { doc.addImage(obj.fotos[i], 'JPEG', M, y, 595 - 2*M, 320); } catch(e) {}
      y += 330;
    }
  }

  // ===== FIRMA =====
  if (y > doc.internal.pageSize.getHeight() - 180) { doc.addPage(); y = M; }
  doc.setDrawColor(60,80,120); doc.rect(M, y, 320, 110);
  doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.text('Firma del cliente / conformidad', M + 8, y + 16);
  if (obj.firma){ try { doc.addImage(obj.firma, 'PNG', M + 8, y + 24, 300, 80); } catch(e) {} }

  // ===== PIE =====
  doc.setDrawColor(200,210,230); doc.line(M, 820, 595 - M, 820);
  doc.setFontSize(8); doc.setTextColor(120,140,170); doc.text('Generado localmente — sin Service Worker.', M, 834);

  const nombre = `OT_${String(obj.consecutivo).padStart(5,'0')}_${(obj.cliente||'Cliente').replace(/[^a-z0-9\\-_]+/gi,'_')}.pdf`;
  doc.save(nombre);
}

    /**************** Exportar/Importar JSON ****************/
    document.getElementById('exportarTodo').addEventListener('click', async ()=>{ const datos = loadReportes(); const blob = new Blob([JSON.stringify(datos, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'reportes_backup.json'; a.click(); });
    document.getElementById('importarBtn').addEventListener('click', ()=> document.getElementById('importarInput').click());
    document.getElementById('importarInput').addEventListener('change', async ev =>{ const file = ev.target.files?.[0]; if (!file) return; const text = await file.text(); try { const arr = JSON.parse(text); if (!Array.isArray(arr)) throw new Error('Formato'); const actuales = loadReportes(); const merged = [...actuales, ...arr]; saveReportes(merged); renderTabla(); toast('Importado'); } catch(e){ alert('Archivo inválido'); } });

    /**************** Botones ****************/
    document.getElementById('pdf').addEventListener('click', ()=> generarPDF());

    /**************** UI init ****************/
    function toast(msg){ const d = document.createElement('div'); d.textContent = msg; d.style.cssText = 'position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#101a35;border:1px solid #253055;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:9999;color:#ebf0ff;'; document.body.appendChild(d); setTimeout(()=> d.remove(), 2200); }
    function init(){ initFechaHora(); document.getElementById('numReporte').value = peekConsecutivo(); renderTabla(); }
    init();
  </script>
</body>
</html>
